<?php
require_once('donateconfig.php');

// Connect to MySQL
$conn = mysqli_connect(DBHOST, DBUSER, DBPASS);
if (mysqli_connect_errno()) {
    die("Connection failed: " . mysqli_connect_error());
}

// Create database
$conn->query("CREATE DATABASE IF NOT EXISTS petadopt_db");
$conn->select_db("petadopt_db");

// donations table exists
$checkTableQuery = "SHOW TABLES LIKE 'donations'";
$tableExists = $conn->query($checkTableQuery);

// create table if it doesn't exist
if (!$tableExists || $tableExists->num_rows == 0) {
    $createTableSQL = "CREATE TABLE donations (
        id INT AUTO_INCREMENT PRIMARY KEY,
        email VARCHAR(255) NOT NULL,
        comment TEXT,
        donation DECIMAL(10,2) NOT NULL
    )";
    $conn->query($createTableSQL);
}

$userJustDonated = false;
$userDonation = null;

if ($_SERVER["REQUEST_METHOD"] == "POST") {
    if (empty($_POST["email"])) {
        $error = "Email is required.";
    } elseif (!filter_var($_POST["email"], FILTER_VALIDATE_EMAIL)) {
        $error = "Invalid email format.";
    } elseif (!isset($_POST["donation"]) || !is_numeric($_POST["donation"]) || $_POST["donation"] <= 0) {
        $error = "Please enter a valid donation amount.";
    } else {
        $stmt = $conn->prepare("INSERT INTO donations (email, comment, donation) VALUES (?, ?, ?)");
        $stmt->bind_param("ssd", $email, $comment, $donation);

        $email = $_POST["email"];
        $comment = $_POST["comment"];
        $donation = (float)$_POST["donation"];

        if ($stmt->execute()) {
            $success = "ðŸŽ‰ Thank you for your donation!";
            $userJustDonated = true;
            
            // Get the ID of the donation we just inserted
            $donationId = $conn->insert_id;
            
            // Query just this donation
            $getInsertedDonation = $conn->prepare("SELECT * FROM donations WHERE id = ?");
            $getInsertedDonation->bind_param("i", $donationId);
            $getInsertedDonation->execute();
            $userDonation = $getInsertedDonation->get_result();
            $getInsertedDonation->close();
        } else {
            $error = "Error: " . $stmt->error;
        }

        $stmt->close();
    }
}

?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PetAdopt Donations</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<?php include 'nav.php'; ?>

<header class="py-5 text-center" style="background-color: #e0f2f1;">
    <div class="container">
        <h1 class="display-5 fw-bold">Support PetAdopt</h1>
        <p class="lead">Every dollar helps save lives. Thank you for your support!</p>
    </div>
</header>

<main class="container my-5">
    <?php if (isset($error)): ?>
        <div class="alert alert-danger"><?php echo $error; ?></div>
    <?php endif; ?>

    <?php if (isset($success)): ?>
        <div class="alert alert-success"><?php echo $success; ?></div>
    <?php endif; ?>

    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <h4 class="card-title">Make a Donation</h4>
            <form method="POST" action="<?php echo htmlspecialchars($_SERVER["PHP_SELF"]); ?>">
                <div class="mb-3">
                    <label for="email" class="form-label">Email address*</label>
                    <input type="email" class="form-control" name="email" id="email" required>
                </div>

                <div class="mb-3">
                    <label for="comment" class="form-label">Comment (optional)</label>
                    <textarea class="form-control" name="comment" id="comment" rows="3"></textarea>
                </div>

                <div class="mb-3">
                    <label for="donation" class="form-label">Donation amount ($)*</label>
                    <input type="number" step="0.01" min="1" class="form-control" name="donation" id="donation" required>
                </div>

                <button type="submit" class="btn btn-success">Donate</button>
            </form>
        </div>
    </div>

    <h2 class="mb-3">Your Donation</h2>
    <?php if ($userJustDonated && $userDonation && $userDonation->num_rows > 0): ?>
        <div class="alert alert-success">
            <p>Thank you for your contribution to PetAdopt! Your donation will help animals in need.</p>
        </div>
        <div class="table-responsive">
            <table class="table table-striped table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>Email</th>
                        <th>Comment</th>
                        <th>Donation ($)</th>
                    </tr>
                </thead>
                <tbody>
                    <?php $row = $userDonation->fetch_assoc(); ?>
                    <tr>
                        <td><?php echo $row["id"]; ?></td>
                        <td><?php echo htmlspecialchars($row["email"]); ?></td>
                        <td><?php echo htmlspecialchars($row["comment"]); ?></td>
                        <td><?php echo number_format($row["donation"], 2); ?></td>
                    </tr>
                </tbody>
            </table>
        </div>
    <?php elseif (!$userJustDonated): ?>
        <p>Make a donation using the form above to see your contribution!</p>
    <?php endif; ?>
</main>

<footer class="bg-light text-center py-4 mt-5">
    <p class="mb-0">&copy; 2025 PetAdopt. All rights reserved.</p>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

<?php mysqli_close($conn); ?>
